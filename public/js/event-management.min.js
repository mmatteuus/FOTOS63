class EventManagementSystem{constructor(){this.currentEvent=null,this.userEvents=[],this.eventCategories=["casamento","aniversario","formatura","corporativo","festa_infantil","batizado","ensaio","show","esporte","outros"],this.competitorPrices={},this.initializeSystem()}initializeSystem(){this.loadUserEvents(),this.loadCompetitorPrices(),this.setupNotificationSystem()}async loadUserEvents(){try{const e=await fetch("/api/events/user",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.userEvents=await e.json())}catch(e){console.error("Error loading user events:",e)}}async loadCompetitorPrices(){try{const e=await fetch("/api/pricing/competitors");e.ok&&(this.competitorPrices=await e.json())}catch(e){console.error("Error loading competitor prices:",e)}}createEventInterface(e){const t=document.getElementById(e);t?(t.innerHTML=`\n            <div class="event-management">\n                <div class="event-header">\n                    <h3><i class="bi bi-calendar-event"></i> Gestão de Eventos</h3>\n                    <button class="btn btn-primary" onclick="showCreateEventModal()">\n                        <i class="bi bi-plus-circle"></i> Criar Evento\n                    </button>\n                </div>\n\n                \x3c!-- Event Statistics --\x3e\n                <div class="event-stats">\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-calendar-check"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="totalEvents">0</h4>\n                            <p>Eventos Criados</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-people"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="totalParticipants">0</h4>\n                            <p>Participantes</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-camera"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="totalPhotos">0</h4>\n                            <p>Fotos Mapeadas</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-currency-dollar"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="totalRevenue">R$ 0</h4>\n                            <p>Receita Gerada</p>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Event Filters --\x3e\n                <div class="event-filters">\n                    <div class="filter-group">\n                        <select class="form-control" id="eventStatusFilter">\n                            <option value="all">Todos os Status</option>\n                            <option value="upcoming">Próximos</option>\n                            <option value="ongoing">Em Andamento</option>\n                            <option value="completed">Concluídos</option>\n                            <option value="cancelled">Cancelados</option>\n                        </select>\n                    </div>\n                    <div class="filter-group">\n                        <select class="form-control" id="eventCategoryFilter">\n                            <option value="all">Todas as Categorias</option>\n                            ${this.eventCategories.map(e=>`\n                                <option value="${e}">${this.getCategoryDisplayName(e)}</option>\n                            `).join("")}\n                        </select>\n                    </div>\n                    <div class="filter-group">\n                        <input type="text" class="form-control" id="eventSearchInput" placeholder="Buscar eventos...">\n                    </div>\n                </div>\n\n                \x3c!-- Events List --\x3e\n                <div class="events-list" id="eventsList">\n                    \x3c!-- Events will be loaded here --\x3e\n                </div>\n\n                \x3c!-- Create Event Modal --\x3e\n                <div class="modal fade" id="createEventModal" tabindex="-1">\n                    <div class="modal-dialog modal-lg">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">Criar Novo Evento</h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <form id="createEventForm">\n                                    \x3c!-- Basic Information --\x3e\n                                    <div class="form-section">\n                                        <h6>Informações Básicas</h6>\n                                        <div class="row">\n                                            <div class="col-md-8">\n                                                <div class="form-group">\n                                                    <label>Nome do Evento *</label>\n                                                    <input type="text" class="form-control" id="eventName" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-4">\n                                                <div class="form-group">\n                                                    <label>Categoria *</label>\n                                                    <select class="form-control" id="eventCategory" required>\n                                                        ${this.eventCategories.map(e=>`\n                                                            <option value="${e}">${this.getCategoryDisplayName(e)}</option>\n                                                        `).join("")}\n                                                    </select>\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class="form-group">\n                                            <label>Descrição</label>\n                                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Date and Time --\x3e\n                                    <div class="form-section">\n                                        <h6>Data e Horário</h6>\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Data de Início *</label>\n                                                    <input type="datetime-local" class="form-control" id="eventStartDate" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Data de Término</label>\n                                                    <input type="datetime-local" class="form-control" id="eventEndDate">\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Location --\x3e\n                                    <div class="form-section">\n                                        <h6>Localização</h6>\n                                        <div class="row">\n                                            <div class="col-md-8">\n                                                <div class="form-group">\n                                                    <label>Endereço Completo *</label>\n                                                    <input type="text" class="form-control" id="eventAddress" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-4">\n                                                <div class="form-group">\n                                                    <label>CEP</label>\n                                                    <input type="text" class="form-control" id="eventZipCode" maxlength="9">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Cidade *</label>\n                                                    <input type="text" class="form-control" id="eventCity" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Estado *</label>\n                                                    <select class="form-control" id="eventState" required>\n                                                        <option value="TO">Tocantins</option>\n                                                        <option value="GO">Goiás</option>\n                                                        <option value="MT">Mato Grosso</option>\n                                                        <option value="PA">Pará</option>\n                                                        <option value="MA">Maranhão</option>\n                                                        \x3c!-- Add more states as needed --\x3e\n                                                    </select>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Organizer Information --\x3e\n                                    <div class="form-section">\n                                        <h6>Informações do Organizador</h6>\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Nome do Organizador *</label>\n                                                    <input type="text" class="form-control" id="organizerName" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>E-mail do Organizador *</label>\n                                                    <input type="email" class="form-control" id="organizerEmail" required>\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Telefone *</label>\n                                                    <input type="tel" class="form-control" id="organizerPhone" required>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>WhatsApp</label>\n                                                    <input type="tel" class="form-control" id="organizerWhatsApp">\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Event Settings --\x3e\n                                    <div class="form-section">\n                                        <h6>Configurações do Evento</h6>\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Número Estimado de Participantes</label>\n                                                    <input type="number" class="form-control" id="expectedParticipants" min="1">\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Tipo de Acesso</label>\n                                                    <select class="form-control" id="eventAccessType">\n                                                        <option value="public">Público</option>\n                                                        <option value="private">Privado</option>\n                                                        <option value="invite_only">Apenas Convidados</option>\n                                                    </select>\n                                                </div>\n                                            </div>\n                                        </div>\n                                        \n                                        <div class="form-group">\n                                            <div class="form-check">\n                                                <input class="form-check-input" type="checkbox" id="enableFacialRecognition" checked>\n                                                <label class="form-check-label" for="enableFacialRecognition">\n                                                    Habilitar Reconhecimento Facial Automático\n                                                </label>\n                                            </div>\n                                        </div>\n                                        \n                                        <div class="form-group">\n                                            <div class="form-check">\n                                                <input class="form-check-input" type="checkbox" id="enableAutoNotifications" checked>\n                                                <label class="form-check-label" for="enableAutoNotifications">\n                                                    Notificar Participantes Automaticamente\n                                                </label>\n                                            </div>\n                                        </div>\n                                        \n                                        <div class="form-group">\n                                            <div class="form-check">\n                                                <input class="form-check-input" type="checkbox" id="enableDynamicPricing" checked>\n                                                <label class="form-check-label" for="enableDynamicPricing">\n                                                    Usar Precificação Dinâmica Competitiva\n                                                </label>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Photographers --\x3e\n                                    <div class="form-section">\n                                        <h6>Fotógrafos</h6>\n                                        <div class="form-group">\n                                            <label>Fotógrafos Convidados</label>\n                                            <div class="photographer-selector" id="photographerSelector">\n                                                <input type="text" class="form-control" id="photographerSearch" \n                                                       placeholder="Buscar fotógrafos...">\n                                                <div class="photographer-list" id="photographerList">\n                                                    \x3c!-- Photographer list will be populated --\x3e\n                                                </div>\n                                            </div>\n                                            <div class="selected-photographers" id="selectedPhotographers">\n                                                \x3c!-- Selected photographers will appear here --\x3e\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Pricing Configuration --\x3e\n                                    <div class="form-section">\n                                        <h6>Configuração de Preços</h6>\n                                        <div class="pricing-strategy">\n                                            <div class="form-group">\n                                                <label>Estratégia de Precificação</label>\n                                                <select class="form-control" id="pricingStrategy">\n                                                    <option value="competitive">Competitiva (1% abaixo da concorrência)</option>\n                                                    <option value="fixed">Preço Fixo</option>\n                                                    <option value="dynamic">Dinâmica por Demanda</option>\n                                                </select>\n                                            </div>\n                                            \n                                            <div class="pricing-details" id="pricingDetails">\n                                                <div class="row">\n                                                    <div class="col-md-6">\n                                                        <div class="form-group">\n                                                            <label>Preço Base por Foto</label>\n                                                            <div class="input-group">\n                                                                <span class="input-group-text">R$</span>\n                                                                <input type="number" class="form-control" id="basePhotoPrice" \n                                                                       step="0.01" min="0">\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class="col-md-6">\n                                                        <div class="form-group">\n                                                            <label>Comissão da Plataforma (%)</label>\n                                                            <input type="number" class="form-control" id="platformCommission" \n                                                                   value="5" min="0" max="20" readonly>\n                                                        </div>\n                                                    </div>\n                                                </div>\n                                                \n                                                <div class="competitive-analysis" id="competitiveAnalysis" style="display: none;">\n                                                    <h6>Análise Competitiva</h6>\n                                                    <div class="competitor-prices" id="competitorPrices">\n                                                        \x3c!-- Competitor prices will be shown here --\x3e\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </form>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>\n                                <button type="button" class="btn btn-primary" onclick="createEvent()">Criar Evento</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Event Details Modal --\x3e\n                <div class="modal fade" id="eventDetailsModal" tabindex="-1">\n                    <div class="modal-dialog modal-xl">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title" id="eventDetailsTitle">Detalhes do Evento</h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body" id="eventDetailsBody">\n                                \x3c!-- Event details will be loaded here --\x3e\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Photo Mapping Interface --\x3e\n                <div class="photo-mapping" id="photoMapping" style="display: none;">\n                    <div class="mapping-header">\n                        <h4>Mapeamento Inteligente de Fotos</h4>\n                        <p>Sistema automático de identificação e sugestão de fotos</p>\n                    </div>\n                    \n                    <div class="mapping-stats">\n                        <div class="stat-item">\n                            <span class="stat-number" id="mappedPhotos">0</span>\n                            <span class="stat-label">Fotos Mapeadas</span>\n                        </div>\n                        <div class="stat-item">\n                            <span class="stat-number" id="identifiedPeople">0</span>\n                            <span class="stat-label">Pessoas Identificadas</span>\n                        </div>\n                        <div class="stat-item">\n                            <span class="stat-number" id="suggestedSales">0</span>\n                            <span class="stat-label">Vendas Sugeridas</span>\n                        </div>\n                    </div>\n                    \n                    <div class="mapping-results" id="mappingResults">\n                        \x3c!-- Mapping results will be shown here --\x3e\n                    </div>\n                </div>\n            </div>\n        `,this.setupEventEvents(),this.loadEventsUI(),this.updateEventStats()):console.error(`Container ${e} not found`)}setupEventEvents(){document.getElementById("eventSearchInput").addEventListener("input",e=>{this.filterEvents()}),document.getElementById("eventStatusFilter").addEventListener("change",()=>{this.filterEvents()}),document.getElementById("eventCategoryFilter").addEventListener("change",()=>{this.filterEvents()}),document.getElementById("pricingStrategy").addEventListener("change",e=>{this.handlePricingStrategyChange(e.target.value)}),document.getElementById("photographerSearch").addEventListener("input",e=>{this.searchPhotographers(e.target.value)}),document.getElementById("eventZipCode").addEventListener("input",e=>{let t=e.target.value.replace(/\D/g,"");t=t.replace(/(\d{5})(\d)/,"$1-$2"),e.target.value=t}),["organizerPhone","organizerWhatsApp"].forEach(e=>{document.getElementById(e).addEventListener("input",e=>{let t=e.target.value.replace(/\D/g,"");t=t.replace(/(\d{2})(\d)/,"($1) $2"),t=t.replace(/(\d{4})(\d)/,"$1-$2"),t=t.replace(/(\d{4})-(\d)(\d{4})/,"$1$2-$3"),e.target.value=t})})}getCategoryDisplayName(e){return{casamento:"Casamento",aniversario:"Aniversário",formatura:"Formatura",corporativo:"Corporativo",festa_infantil:"Festa Infantil",batizado:"Batizado",ensaio:"Ensaio Fotográfico",show:"Show/Evento Musical",esporte:"Evento Esportivo",outros:"Outros"}[e]||e}loadEventsUI(){const e=document.getElementById("eventsList");e&&(0!==this.userEvents.length?e.innerHTML=this.userEvents.map(e=>`\n            <div class="event-card" data-event-id="${e.id}">\n                <div class="event-header">\n                    <div class="event-info">\n                        <h5>${e.name}</h5>\n                        <p class="event-category">${this.getCategoryDisplayName(e.category)}</p>\n                    </div>\n                    <div class="event-status">\n                        <span class="badge bg-${this.getEventStatusColor(e.status)}">${e.status}</span>\n                    </div>\n                </div>\n                \n                <div class="event-details">\n                    <div class="detail-item">\n                        <i class="bi bi-calendar"></i>\n                        <span>${this.formatEventDate(e.start_date,e.end_date)}</span>\n                    </div>\n                    <div class="detail-item">\n                        <i class="bi bi-geo-alt"></i>\n                        <span>${e.city}, ${e.state}</span>\n                    </div>\n                    <div class="detail-item">\n                        <i class="bi bi-people"></i>\n                        <span>${e.participants_count||0} participantes</span>\n                    </div>\n                    <div class="detail-item">\n                        <i class="bi bi-camera"></i>\n                        <span>${e.photos_count||0} fotos mapeadas</span>\n                    </div>\n                </div>\n                \n                <div class="event-stats">\n                    <div class="stat">\n                        <span class="stat-value">${e.sales_count||0}</span>\n                        <span class="stat-label">Vendas</span>\n                    </div>\n                    <div class="stat">\n                        <span class="stat-value">R$ ${(e.revenue||0).toFixed(2)}</span>\n                        <span class="stat-label">Receita</span>\n                    </div>\n                </div>\n                \n                <div class="event-actions">\n                    <button class="btn btn-sm btn-outline-primary" onclick="viewEventDetails('${e.id}')">\n                        <i class="bi bi-eye"></i> Ver Detalhes\n                    </button>\n                    <button class="btn btn-sm btn-outline-success" onclick="viewPhotoMapping('${e.id}')">\n                        <i class="bi bi-search"></i> Mapeamento\n                    </button>\n                    <button class="btn btn-sm btn-outline-secondary" onclick="editEvent('${e.id}')">\n                        <i class="bi bi-pencil"></i> Editar\n                    </button>\n                </div>\n            </div>\n        `).join(""):e.innerHTML='\n                <div class="empty-state">\n                    <i class="bi bi-calendar-x"></i>\n                    <h4>Nenhum evento criado</h4>\n                    <p>Crie seu primeiro evento para começar a mapear fotos automaticamente</p>\n                    <button class="btn btn-primary" onclick="showCreateEventModal()">\n                        <i class="bi bi-plus-circle"></i> Criar Primeiro Evento\n                    </button>\n                </div>\n            ')}getEventStatusColor(e){return{upcoming:"primary",ongoing:"success",completed:"secondary",cancelled:"danger"}[e]||"secondary"}formatEventDate(e,t){const n=new Date(e),a=t?new Date(t):null,i={day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"};return a&&n.toDateString()!==a.toDateString()?`${n.toLocaleDateString("pt-BR",i)} - ${a.toLocaleDateString("pt-BR",i)}`:n.toLocaleDateString("pt-BR",i)}updateEventStats(){const e=this.userEvents.length,t=this.userEvents.reduce((e,t)=>e+(t.participants_count||0),0),n=this.userEvents.reduce((e,t)=>e+(t.photos_count||0),0),a=this.userEvents.reduce((e,t)=>e+(t.revenue||0),0);document.getElementById("totalEvents").textContent=e,document.getElementById("totalParticipants").textContent=t,document.getElementById("totalPhotos").textContent=n,document.getElementById("totalRevenue").textContent=`R$ ${a.toFixed(2)}`}filterEvents(){const e=document.getElementById("eventSearchInput").value.toLowerCase(),t=document.getElementById("eventStatusFilter").value,n=document.getElementById("eventCategoryFilter").value;document.querySelectorAll(".event-card").forEach(a=>{const i=a.dataset.eventId,o=this.userEvents.find(e=>e.id===i);if(!o)return;const s=!e||o.name.toLowerCase().includes(e)||o.city.toLowerCase().includes(e)||o.organizer_name.toLowerCase().includes(e),r="all"===t||o.status===t,l="all"===n||o.category===n,c=s&&r&&l;a.style.display=c?"block":"none"})}showCreateEventModal(){new bootstrap.Modal(document.getElementById("createEventModal")).show(),this.loadPhotographersForSelection(),this.setDefaultEventValues()}setDefaultEventValues(){const e=new Date;e.setDate(e.getDate()+1),e.setHours(18,0,0,0),document.getElementById("eventStartDate").value=e.toISOString().slice(0,16);const t=new Date(e);t.setHours(22,0,0,0),document.getElementById("eventEndDate").value=t.toISOString().slice(0,16)}async loadPhotographersForSelection(){try{const e=await fetch("/api/photographers/available",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.availablePhotographers=await e.json(),this.updatePhotographerList())}catch(e){console.error("Error loading photographers:",e)}}updatePhotographerList(e=""){const t=document.getElementById("photographerList");if(!t||!this.availablePhotographers)return;const n=this.availablePhotographers.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.specialties.some(t=>t.toLowerCase().includes(e.toLowerCase())));t.innerHTML=n.map(e=>`\n            <div class="photographer-item" onclick="selectPhotographer('${e.id}')">\n                <img src="${e.avatar||"/default-avatar.png"}" alt="${e.name}" class="photographer-avatar">\n                <div class="photographer-info">\n                    <h6>${e.name}</h6>\n                    <p>${e.specialties.join(", ")}</p>\n                    <div class="photographer-rating">\n                        ${this.generateStarRating(e.rating)}\n                        <span>(${e.reviews_count} avaliações)</span>\n                    </div>\n                </div>\n                <div class="photographer-price">\n                    <span>A partir de R$ ${e.min_price}</span>\n                </div>\n            </div>\n        `).join("")}generateStarRating(e){const t=Math.floor(e),n=e%1>=.5,a=5-t-(n?1:0);return[...Array(t).fill('<i class="bi bi-star-fill"></i>'),...n?['<i class="bi bi-star-half"></i>']:[],...Array(a).fill('<i class="bi bi-star"></i>')].join("")}searchPhotographers(e){this.updatePhotographerList(e)}selectPhotographer(e){const t=this.availablePhotographers.find(t=>t.id===e);t&&(this.selectedPhotographers||(this.selectedPhotographers=[]),this.selectedPhotographers.find(t=>t.id===e)||(this.selectedPhotographers.push(t),this.updateSelectedPhotographers()))}updateSelectedPhotographers(){const e=document.getElementById("selectedPhotographers");e&&this.selectedPhotographers&&(e.innerHTML=this.selectedPhotographers.map(e=>`\n            <div class="selected-photographer">\n                <img src="${e.avatar||"/default-avatar.png"}" alt="${e.name}">\n                <span>${e.name}</span>\n                <button class="btn btn-sm btn-outline-danger" onclick="removeSelectedPhotographer('${e.id}')">\n                    <i class="bi bi-x"></i>\n                </button>\n            </div>\n        `).join(""))}removeSelectedPhotographer(e){this.selectedPhotographers&&(this.selectedPhotographers=this.selectedPhotographers.filter(t=>t.id!==e),this.updateSelectedPhotographers())}handlePricingStrategyChange(e){const t=document.getElementById("competitiveAnalysis"),n=document.getElementById("basePhotoPrice");"competitive"===e?(t.style.display="block",n.readOnly=!0,this.loadCompetitivePricing()):(t.style.display="none",n.readOnly=!1)}async loadCompetitivePricing(){try{const e=document.getElementById("eventCategory").value,t=await fetch(`/api/pricing/competitive/${e}`);if(t.ok){const e=await t.json();this.displayCompetitivePricing(e)}}catch(e){console.error("Error loading competitive pricing:",e)}}displayCompetitivePricing(e){const t=document.getElementById("competitorPrices");if(!t)return;const n=Math.min(...e.map(e=>e.price)),a=Math.max(1,.99*n);t.innerHTML=`\n            <div class="competitive-summary">\n                <h6>Análise de Preços da Concorrência</h6>\n                <div class="competitor-list">\n                    ${e.map(e=>`\n                        <div class="competitor-item">\n                            <span class="competitor-name">${e.name}</span>\n                            <span class="competitor-price">R$ ${e.price.toFixed(2)}</span>\n                        </div>\n                    `).join("")}\n                </div>\n                <div class="our-price">\n                    <strong>Nosso Preço Sugerido: R$ ${a.toFixed(2)}</strong>\n                    <small>(1% abaixo do menor preço da concorrência)</small>\n                </div>\n            </div>\n        `,document.getElementById("basePhotoPrice").value=a.toFixed(2)}async createEvent(){try{const e=this.collectEventData();if(!this.validateEventData(e))return;const t=await fetch("/api/events",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify(e)});if(!t.ok)throw new Error("Erro ao criar evento");const n=await t.json();this.userEvents.unshift(n),this.loadEventsUI(),this.updateEventStats();bootstrap.Modal.getInstance(document.getElementById("createEventModal")).hide(),alert("Evento criado com sucesso!"),e.enable_facial_recognition&&this.startPhotoMapping(n.id),e.enable_auto_notifications&&this.sendEventNotifications(n.id)}catch(e){console.error("Error creating event:",e),alert("Erro ao criar evento: "+e.message)}}collectEventData(){return{name:document.getElementById("eventName").value,description:document.getElementById("eventDescription").value,category:document.getElementById("eventCategory").value,start_date:document.getElementById("eventStartDate").value,end_date:document.getElementById("eventEndDate").value,address:document.getElementById("eventAddress").value,zip_code:document.getElementById("eventZipCode").value,city:document.getElementById("eventCity").value,state:document.getElementById("eventState").value,organizer_name:document.getElementById("organizerName").value,organizer_email:document.getElementById("organizerEmail").value,organizer_phone:document.getElementById("organizerPhone").value,organizer_whatsapp:document.getElementById("organizerWhatsApp").value,expected_participants:parseInt(document.getElementById("expectedParticipants").value)||0,access_type:document.getElementById("eventAccessType").value,enable_facial_recognition:document.getElementById("enableFacialRecognition").checked,enable_auto_notifications:document.getElementById("enableAutoNotifications").checked,enable_dynamic_pricing:document.getElementById("enableDynamicPricing").checked,pricing_strategy:document.getElementById("pricingStrategy").value,base_photo_price:parseFloat(document.getElementById("basePhotoPrice").value)||0,platform_commission:parseFloat(document.getElementById("platformCommission").value)||5,selected_photographers:this.selectedPhotographers||[]}}validateEventData(e){const t=["name","category","start_date","address","city","state","organizer_name","organizer_email","organizer_phone"];for(const n of t)if(!e[n]||""===e[n].trim())return alert(`Por favor, preencha o campo: ${n}`),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.organizer_email))return alert("Por favor, digite um e-mail válido"),!1;const n=new Date(e.start_date),a=e.end_date?new Date(e.end_date):null;return n<new Date?(alert("A data de início deve ser futura"),!1):!(a&&a<=n)||(alert("A data de término deve ser posterior à data de início"),!1)}async startPhotoMapping(e){try{(await fetch(`/api/events/${e}/start-mapping`,{method:"POST",headers:{Authorization:`Bearer ${this.getAuthToken()}`}})).ok&&console.log("Photo mapping started for event:",e)}catch(e){console.error("Error starting photo mapping:",e)}}async sendEventNotifications(e){try{(await fetch(`/api/events/${e}/notify`,{method:"POST",headers:{Authorization:`Bearer ${this.getAuthToken()}`}})).ok&&console.log("Event notifications sent for event:",e)}catch(e){console.error("Error sending event notifications:",e)}}async viewEventDetails(e){try{const t=await fetch(`/api/events/${e}`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});if(t.ok){const e=await t.json();this.showEventDetailsModal(e)}}catch(e){console.error("Error loading event details:",e)}}showEventDetailsModal(e){const t=new bootstrap.Modal(document.getElementById("eventDetailsModal"));document.getElementById("eventDetailsTitle").textContent=e.name,document.getElementById("eventDetailsBody").innerHTML=this.generateEventDetailsHTML(e),t.show()}generateEventDetailsHTML(e){return`\n            <div class="event-details-content">\n                <div class="row">\n                    <div class="col-md-8">\n                        <div class="detail-section">\n                            <h6>Informações Gerais</h6>\n                            <p><strong>Categoria:</strong> ${this.getCategoryDisplayName(e.category)}</p>\n                            <p><strong>Descrição:</strong> ${e.description||"Não informado"}</p>\n                            <p><strong>Status:</strong> <span class="badge bg-${this.getEventStatusColor(e.status)}">${e.status}</span></p>\n                        </div>\n\n                        <div class="detail-section">\n                            <h6>Data e Local</h6>\n                            <p><strong>Início:</strong> ${this.formatEventDate(e.start_date)}</p>\n                            ${e.end_date?`<p><strong>Término:</strong> ${this.formatEventDate(e.end_date)}</p>`:""}\n                            <p><strong>Endereço:</strong> ${e.address}</p>\n                            <p><strong>Cidade:</strong> ${e.city}, ${e.state}</p>\n                        </div>\n\n                        <div class="detail-section">\n                            <h6>Organizador</h6>\n                            <p><strong>Nome:</strong> ${e.organizer_name}</p>\n                            <p><strong>E-mail:</strong> ${e.organizer_email}</p>\n                            <p><strong>Telefone:</strong> ${e.organizer_phone}</p>\n                            ${e.organizer_whatsapp?`<p><strong>WhatsApp:</strong> ${e.organizer_whatsapp}</p>`:""}\n                        </div>\n                    </div>\n\n                    <div class="col-md-4">\n                        <div class="detail-section">\n                            <h6>Estatísticas</h6>\n                            <div class="stat-grid">\n                                <div class="stat-item">\n                                    <span class="stat-number">${e.participants_count||0}</span>\n                                    <span class="stat-label">Participantes</span>\n                                </div>\n                                <div class="stat-item">\n                                    <span class="stat-number">${e.photos_count||0}</span>\n                                    <span class="stat-label">Fotos</span>\n                                </div>\n                                <div class="stat-item">\n                                    <span class="stat-number">${e.sales_count||0}</span>\n                                    <span class="stat-label">Vendas</span>\n                                </div>\n                                <div class="stat-item">\n                                    <span class="stat-number">R$ ${(e.revenue||0).toFixed(2)}</span>\n                                    <span class="stat-label">Receita</span>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="detail-section">\n                            <h6>Configurações</h6>\n                            <p><strong>Acesso:</strong> ${e.access_type}</p>\n                            <p><strong>Reconhecimento Facial:</strong> ${e.enable_facial_recognition?"Ativo":"Inativo"}</p>\n                            <p><strong>Notificações:</strong> ${e.enable_auto_notifications?"Ativas":"Inativas"}</p>\n                            <p><strong>Preço Base:</strong> R$ ${(e.base_photo_price||0).toFixed(2)}</p>\n                        </div>\n                    </div>\n                </div>\n\n                ${e.photographers&&e.photographers.length>0?`\n                    <div class="detail-section">\n                        <h6>Fotógrafos</h6>\n                        <div class="photographers-grid">\n                            ${e.photographers.map(e=>`\n                                <div class="photographer-card">\n                                    <img src="${e.avatar||"/default-avatar.png"}" alt="${e.name}">\n                                    <div class="photographer-info">\n                                        <h6>${e.name}</h6>\n                                        <p>${e.specialties.join(", ")}</p>\n                                    </div>\n                                </div>\n                            `).join("")}\n                        </div>\n                    </div>\n                `:""}\n            </div>\n        `}async viewPhotoMapping(e){try{const t=await fetch(`/api/events/${e}/mapping`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});if(t.ok){const e=await t.json();this.showPhotoMapping(e)}}catch(e){console.error("Error loading photo mapping:",e)}}showPhotoMapping(e){document.getElementById("photoMapping").style.display="block",document.getElementById("mappedPhotos").textContent=e.total_photos||0,document.getElementById("identifiedPeople").textContent=e.identified_people||0,document.getElementById("suggestedSales").textContent=e.suggested_sales||0;document.getElementById("mappingResults").innerHTML=this.generateMappingResultsHTML(e.results||[])}generateMappingResultsHTML(e){return 0===e.length?'<p class="text-muted text-center">Nenhum resultado de mapeamento disponível ainda.</p>':`\n            <div class="mapping-results-grid">\n                ${e.map(e=>`\n                    <div class="mapping-result-card">\n                        <div class="result-header">\n                            <h6>${e.participant_name}</h6>\n                            <span class="badge bg-primary">${e.photos_count} fotos</span>\n                        </div>\n                        <div class="result-photos">\n                            ${e.photos.slice(0,4).map(e=>`\n                                <img src="${e.thumbnail_url}" alt="Foto" class="result-photo">\n                            `).join("")}\n                            ${e.photos.length>4?`\n                                <div class="more-photos">+${e.photos.length-4}</div>\n                            `:""}\n                        </div>\n                        <div class="result-actions">\n                            <button class="btn btn-sm btn-primary" onclick="notifyParticipant('${e.participant_id}', '${e.event_id}')">\n                                <i class="bi bi-bell"></i> Notificar\n                            </button>\n                            <button class="btn btn-sm btn-outline-secondary" onclick="viewParticipantPhotos('${e.participant_id}', '${e.event_id}')">\n                                <i class="bi bi-eye"></i> Ver Todas\n                            </button>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n        `}setupNotificationSystem(){"Notification"in window&&Notification.requestPermission(),this.setupWebSocketConnection()}setupWebSocketConnection(){try{const e=`wss://${window.location.host}/ws/events`;this.ws=new WebSocket(e),this.ws.onmessage=e=>{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)},this.ws.onclose=()=>{setTimeout(()=>this.setupWebSocketConnection(),5e3)}}catch(e){console.error("WebSocket connection error:",e)}}handleWebSocketMessage(e){switch(e.type){case"new_event_participant":this.handleNewParticipant(e);break;case"photo_mapping_complete":this.handlePhotoMappingComplete(e);break;case"new_photo_sale":this.handleNewPhotoSale(e)}}handleNewParticipant(e){this.loadUserEvents().then(()=>{this.loadEventsUI(),this.updateEventStats()}),"granted"===Notification.permission&&new Notification("Novo Participante",{body:`${e.participant_name} se inscreveu no evento ${e.event_name}`,icon:"/favicon.ico"})}handlePhotoMappingComplete(e){"block"===document.getElementById("photoMapping").style.display&&this.viewPhotoMapping(e.event_id),"granted"===Notification.permission&&new Notification("Mapeamento Concluído",{body:`${e.photos_count} fotos foram mapeadas para o evento ${e.event_name}`,icon:"/favicon.ico"})}handleNewPhotoSale(e){this.loadUserEvents().then(()=>{this.loadEventsUI(),this.updateEventStats()}),"granted"===Notification.permission&&new Notification("Nova Venda",{body:`Foto vendida por R$ ${e.amount.toFixed(2)} no evento ${e.event_name}`,icon:"/favicon.ico"})}getAuthToken(){return localStorage.getItem("fotos63_auth_token")||""}}function showCreateEventModal(){eventManagement.showCreateEventModal()}function createEvent(){eventManagement.createEvent()}function selectPhotographer(e){eventManagement.selectPhotographer(e)}function removeSelectedPhotographer(e){eventManagement.removeSelectedPhotographer(e)}function viewEventDetails(e){eventManagement.viewEventDetails(e)}function viewPhotoMapping(e){eventManagement.viewPhotoMapping(e)}function editEvent(e){alert(`Editar evento ${e} - Em desenvolvimento`)}function notifyParticipant(e,t){alert(`Notificar participante ${e} - Em desenvolvimento`)}function viewParticipantPhotos(e,t){alert(`Ver fotos do participante ${e} - Em desenvolvimento`)}const eventManagement=new EventManagementSystem;"undefined"!=typeof module&&module.exports&&(module.exports=EventManagementSystem);