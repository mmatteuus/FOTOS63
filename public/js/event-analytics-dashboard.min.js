class EventAnalyticsDashboard{constructor(){this.currentEvent=null,this.participants=[],this.filteredParticipants=[],this.charts={},this.filters={age:{min:0,max:100},gender:"all",location:"all",registration_date:"all",participation_status:"all",photo_purchases:"all"},this.initializeDashboard()}initializeDashboard(){this.loadChartLibraries(),this.setupExportLibraries()}loadChartLibraries(){if(!window.Chart){const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js",document.head.appendChild(t)}}setupExportLibraries(){if(!window.jsPDF){const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",document.head.appendChild(t)}if(!window.XLSX){const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",document.head.appendChild(t)}}createAnalyticsDashboard(t,e){const a=document.getElementById(t);a?(this.currentEvent=e,a.innerHTML='\n            <div class="event-analytics-dashboard">\n                <div class="dashboard-header">\n                    <div class="header-info">\n                        <h3><i class="bi bi-graph-up"></i> Analytics do Evento</h3>\n                        <p class="event-name" id="eventName">Carregando...</p>\n                    </div>\n                    <div class="header-actions">\n                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">\n                            <i class="bi bi-arrow-clockwise"></i> Atualizar\n                        </button>\n                        <div class="dropdown">\n                            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">\n                                <i class="bi bi-download"></i> Exportar\n                            </button>\n                            <ul class="dropdown-menu">\n                                <li><a class="dropdown-item" href="#" onclick="exportToPDF()">\n                                    <i class="bi bi-file-pdf"></i> Relatório PDF\n                                </a></li>\n                                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">\n                                    <i class="bi bi-file-excel"></i> Planilha Excel\n                                </a></li>\n                                <li><a class="dropdown-item" href="#" onclick="exportParticipantsList()">\n                                    <i class="bi bi-people"></i> Lista de Participantes\n                                </a></li>\n                                <li><hr class="dropdown-divider"></li>\n                                <li><a class="dropdown-item" href="#" onclick="exportCustomReport()">\n                                    <i class="bi bi-gear"></i> Relatório Personalizado\n                                </a></li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Key Metrics Cards --\x3e\n                <div class="metrics-cards">\n                    <div class="metric-card">\n                        <div class="metric-icon">\n                            <i class="bi bi-people-fill"></i>\n                        </div>\n                        <div class="metric-info">\n                            <h4 id="totalParticipants">0</h4>\n                            <p>Total de Inscritos</p>\n                            <small class="metric-change" id="participantsChange">+0% vs. último evento</small>\n                        </div>\n                    </div>\n\n                    <div class="metric-card">\n                        <div class="metric-icon">\n                            <i class="bi bi-check-circle-fill"></i>\n                        </div>\n                        <div class="metric-info">\n                            <h4 id="confirmedParticipants">0</h4>\n                            <p>Confirmados</p>\n                            <small class="metric-change" id="confirmationRate">0% taxa de confirmação</small>\n                        </div>\n                    </div>\n\n                    <div class="metric-card">\n                        <div class="metric-icon">\n                            <i class="bi bi-camera-fill"></i>\n                        </div>\n                        <div class="metric-info">\n                            <h4 id="photoPurchasers">0</h4>\n                            <p>Compraram Fotos</p>\n                            <small class="metric-change" id="purchaseRate">0% taxa de compra</small>\n                        </div>\n                    </div>\n\n                    <div class="metric-card">\n                        <div class="metric-icon">\n                            <i class="bi bi-currency-dollar"></i>\n                        </div>\n                        <div class="metric-info">\n                            <h4 id="totalRevenue">R$ 0</h4>\n                            <p>Receita Total</p>\n                            <small class="metric-change" id="revenuePerParticipant">R$ 0 por participante</small>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Advanced Filters --\x3e\n                <div class="analytics-filters">\n                    <div class="filters-header">\n                        <h5><i class="bi bi-funnel"></i> Filtros Avançados</h5>\n                        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">\n                            <i class="bi bi-arrow-counterclockwise"></i> Limpar Filtros\n                        </button>\n                    </div>\n\n                    <div class="filters-grid">\n                        <div class="filter-group">\n                            <label>Faixa Etária</label>\n                            <div class="age-range-slider">\n                                <input type="range" id="ageMin" min="0" max="100" value="0" class="form-range">\n                                <input type="range" id="ageMax" min="0" max="100" value="100" class="form-range">\n                                <div class="range-labels">\n                                    <span id="ageMinLabel">0</span> - <span id="ageMaxLabel">100</span> anos\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="filter-group">\n                            <label>Gênero</label>\n                            <select class="form-control" id="genderFilter">\n                                <option value="all">Todos</option>\n                                <option value="male">Masculino</option>\n                                <option value="female">Feminino</option>\n                                <option value="other">Outro</option>\n                                <option value="not_informed">Não Informado</option>\n                            </select>\n                        </div>\n\n                        <div class="filter-group">\n                            <label>Localização</label>\n                            <select class="form-control" id="locationFilter">\n                                <option value="all">Todas as Cidades</option>\n                                \x3c!-- Cities will be populated dynamically --\x3e\n                            </select>\n                        </div>\n\n                        <div class="filter-group">\n                            <label>Data de Inscrição</label>\n                            <select class="form-control" id="registrationDateFilter">\n                                <option value="all">Todas as Datas</option>\n                                <option value="last_24h">Últimas 24h</option>\n                                <option value="last_week">Última Semana</option>\n                                <option value="last_month">Último Mês</option>\n                                <option value="custom">Período Personalizado</option>\n                            </select>\n                            <div class="custom-date-range" id="customDateRange" style="display: none;">\n                                <input type="date" class="form-control" id="startDate">\n                                <input type="date" class="form-control" id="endDate">\n                            </div>\n                        </div>\n\n                        <div class="filter-group">\n                            <label>Status de Participação</label>\n                            <select class="form-control" id="participationStatusFilter">\n                                <option value="all">Todos os Status</option>\n                                <option value="registered">Inscrito</option>\n                                <option value="confirmed">Confirmado</option>\n                                <option value="attended">Compareceu</option>\n                                <option value="no_show">Não Compareceu</option>\n                                <option value="cancelled">Cancelado</option>\n                            </select>\n                        </div>\n\n                        <div class="filter-group">\n                            <label>Compras de Fotos</label>\n                            <select class="form-control" id="photoPurchasesFilter">\n                                <option value="all">Todos</option>\n                                <option value="purchased">Compraram Fotos</option>\n                                <option value="not_purchased">Não Compraram</option>\n                                <option value="high_value">Alto Valor (>R$ 100)</option>\n                                <option value="medium_value">Médio Valor (R$ 50-100)</option>\n                                <option value="low_value">Baixo Valor (<R$ 50)</option>\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class="filter-results">\n                        <span class="results-count">\n                            Mostrando <strong id="filteredCount">0</strong> de <strong id="totalCount">0</strong> participantes\n                        </span>\n                        <div class="quick-filters">\n                            <button class="btn btn-sm btn-outline-primary" onclick="applyQuickFilter(\'vip\')">\n                                <i class="bi bi-star"></i> VIPs\n                            </button>\n                            <button class="btn btn-sm btn-outline-success" onclick="applyQuickFilter(\'high_engagement\')">\n                                <i class="bi bi-heart"></i> Alto Engajamento\n                            </button>\n                            <button class="btn btn-sm btn-outline-warning" onclick="applyQuickFilter(\'potential_buyers\')">\n                                <i class="bi bi-cart"></i> Potenciais Compradores\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Charts Section --\x3e\n                <div class="charts-section">\n                    <div class="charts-grid">\n                        \x3c!-- Demographics Chart --\x3e\n                        <div class="chart-container">\n                            <div class="chart-header">\n                                <h5>Demografia dos Participantes</h5>\n                                <div class="chart-controls">\n                                    <select class="form-control form-control-sm" id="demographicsType">\n                                        <option value="age">Por Idade</option>\n                                        <option value="gender">Por Gênero</option>\n                                        <option value="location">Por Localização</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <canvas id="demographicsChart"></canvas>\n                        </div>\n\n                        \x3c!-- Registration Timeline --\x3e\n                        <div class="chart-container">\n                            <div class="chart-header">\n                                <h5>Timeline de Inscrições</h5>\n                                <div class="chart-controls">\n                                    <select class="form-control form-control-sm" id="timelineGranularity">\n                                        <option value="daily">Por Dia</option>\n                                        <option value="hourly">Por Hora</option>\n                                        <option value="weekly">Por Semana</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <canvas id="registrationTimelineChart"></canvas>\n                        </div>\n\n                        \x3c!-- Engagement Metrics --\x3e\n                        <div class="chart-container">\n                            <div class="chart-header">\n                                <h5>Métricas de Engajamento</h5>\n                            </div>\n                            <canvas id="engagementChart"></canvas>\n                        </div>\n\n                        \x3c!-- Revenue Analysis --\x3e\n                        <div class="chart-container">\n                            <div class="chart-header">\n                                <h5>Análise de Receita</h5>\n                                <div class="chart-controls">\n                                    <select class="form-control form-control-sm" id="revenueBreakdown">\n                                        <option value="by_participant">Por Participante</option>\n                                        <option value="by_photo_type">Por Tipo de Foto</option>\n                                        <option value="by_package">Por Pacote</option>\n                                    </select>\n                                </div>\n                            </div>\n                            <canvas id="revenueChart"></canvas>\n                        </div>\n\n                        \x3c!-- Conversion Funnel --\x3e\n                        <div class="chart-container full-width">\n                            <div class="chart-header">\n                                <h5>Funil de Conversão</h5>\n                            </div>\n                            <canvas id="conversionFunnelChart"></canvas>\n                        </div>\n\n                        \x3c!-- Heatmap --\x3e\n                        <div class="chart-container full-width">\n                            <div class="chart-header">\n                                <h5>Mapa de Calor - Atividade por Hora/Dia</h5>\n                            </div>\n                            <div id="activityHeatmap" class="heatmap-container">\n                                \x3c!-- Heatmap will be generated here --\x3e\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Detailed Participants Table --\x3e\n                <div class="participants-table-section">\n                    <div class="table-header">\n                        <h5><i class="bi bi-table"></i> Lista Detalhada de Participantes</h5>\n                        <div class="table-controls">\n                            <input type="text" class="form-control" id="participantSearch" placeholder="Buscar participante...">\n                            <select class="form-control" id="tablePageSize">\n                                <option value="25">25 por página</option>\n                                <option value="50">50 por página</option>\n                                <option value="100">100 por página</option>\n                                <option value="all">Todos</option>\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class="table-responsive">\n                        <table class="table table-striped" id="participantsTable">\n                            <thead>\n                                <tr>\n                                    <th><input type="checkbox" id="selectAll"></th>\n                                    <th>Nome <i class="bi bi-arrow-down-up sort-icon" data-column="name"></i></th>\n                                    <th>Email <i class="bi bi-arrow-down-up sort-icon" data-column="email"></i></th>\n                                    <th>Idade <i class="bi bi-arrow-down-up sort-icon" data-column="age"></i></th>\n                                    <th>Cidade <i class="bi bi-arrow-down-up sort-icon" data-column="city"></i></th>\n                                    <th>Inscrição <i class="bi bi-arrow-down-up sort-icon" data-column="registration_date"></i></th>\n                                    <th>Status <i class="bi bi-arrow-down-up sort-icon" data-column="status"></i></th>\n                                    <th>Fotos Compradas <i class="bi bi-arrow-down-up sort-icon" data-column="photos_purchased"></i></th>\n                                    <th>Valor Gasto <i class="bi bi-arrow-down-up sort-icon" data-column="total_spent"></i></th>\n                                    <th>Ações</th>\n                                </tr>\n                            </thead>\n                            <tbody id="participantsTableBody">\n                                \x3c!-- Participants data will be loaded here --\x3e\n                            </tbody>\n                        </table>\n                    </div>\n\n                    <div class="table-pagination" id="tablePagination">\n                        \x3c!-- Pagination will be generated here --\x3e\n                    </div>\n                </div>\n\n                \x3c!-- Insights and Recommendations --\x3e\n                <div class="insights-section">\n                    <div class="insights-header">\n                        <h5><i class="bi bi-lightbulb"></i> Insights e Recomendações</h5>\n                    </div>\n                    <div class="insights-grid" id="insightsGrid">\n                        \x3c!-- AI-generated insights will be shown here --\x3e\n                    </div>\n                </div>\n\n                \x3c!-- Export Modal --\x3e\n                <div class="modal fade" id="exportModal" tabindex="-1">\n                    <div class="modal-dialog">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">Exportar Relatório Personalizado</h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <div class="export-options">\n                                    <h6>Selecionar Dados para Exportação</h6>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="checkbox" id="exportBasicInfo" checked>\n                                        <label class="form-check-label" for="exportBasicInfo">Informações Básicas</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="checkbox" id="exportDemographics" checked>\n                                        <label class="form-check-label" for="exportDemographics">Demografia</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="checkbox" id="exportPurchases">\n                                        <label class="form-check-label" for="exportPurchases">Histórico de Compras</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="checkbox" id="exportEngagement">\n                                        <label class="form-check-label" for="exportEngagement">Métricas de Engajamento</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="checkbox" id="exportCharts">\n                                        <label class="form-check-label" for="exportCharts">Gráficos e Visualizações</label>\n                                    </div>\n                                </div>\n\n                                <div class="export-format">\n                                    <h6>Formato de Exportação</h6>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="radio" name="exportFormat" id="formatPDF" value="pdf" checked>\n                                        <label class="form-check-label" for="formatPDF">PDF (Relatório Completo)</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="excel">\n                                        <label class="form-check-label" for="formatExcel">Excel (Dados Tabulares)</label>\n                                    </div>\n                                    <div class="form-check">\n                                        <input class="form-check-input" type="radio" name="exportFormat" id="formatCSV" value="csv">\n                                        <label class="form-check-label" for="formatCSV">CSV (Dados Simples)</label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>\n                                <button type="button" class="btn btn-primary" onclick="executeCustomExport()">\n                                    <i class="bi bi-download"></i> Exportar\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',this.setupDashboardEvents(),this.loadEventData()):console.error(`Container ${t} not found`)}setupDashboardEvents(){["ageMin","ageMax"].forEach(t=>{document.getElementById(t).addEventListener("input",()=>{this.updateAgeRangeLabels(),this.applyFilters()})}),["genderFilter","locationFilter","registrationDateFilter","participationStatusFilter","photoPurchasesFilter"].forEach(t=>{document.getElementById(t).addEventListener("change",()=>{this.applyFilters()})}),document.getElementById("demographicsType").addEventListener("change",()=>{this.updateDemographicsChart()}),document.getElementById("timelineGranularity").addEventListener("change",()=>{this.updateRegistrationTimelineChart()}),document.getElementById("revenueBreakdown").addEventListener("change",()=>{this.updateRevenueChart()}),document.getElementById("participantSearch").addEventListener("input",()=>{this.filterParticipantsTable()}),document.getElementById("tablePageSize").addEventListener("change",()=>{this.updateParticipantsTable()}),document.querySelectorAll(".sort-icon").forEach(t=>{t.addEventListener("click",t=>{this.sortParticipantsTable(t.target.dataset.column)})}),document.getElementById("selectAll").addEventListener("change",t=>{this.toggleSelectAll(t.target.checked)}),document.getElementById("registrationDateFilter").addEventListener("change",t=>{document.getElementById("customDateRange").style.display="custom"===t.target.value?"block":"none"})}async loadEventData(){try{const[t,e,a]=await Promise.all([this.fetchEventInfo(),this.fetchParticipants(),this.fetchEventAnalytics()]);this.participants=e,this.filteredParticipants=[...e],this.updateEventInfo(t),this.updateMetrics(a),this.populateLocationFilter(),this.initializeCharts(),this.updateParticipantsTable(),this.generateInsights()}catch(t){console.error("Error loading event data:",t)}}async fetchEventInfo(){return(await fetch(`/api/events/${this.currentEvent}`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}})).json()}async fetchParticipants(){return(await fetch(`/api/events/${this.currentEvent}/participants`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}})).json()}async fetchEventAnalytics(){return(await fetch(`/api/events/${this.currentEvent}/analytics`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}})).json()}updateEventInfo(t){document.getElementById("eventName").textContent=t.name}updateMetrics(t){document.getElementById("totalParticipants").textContent=t.total_participants||0,document.getElementById("confirmedParticipants").textContent=t.confirmed_participants||0,document.getElementById("photoPurchasers").textContent=t.photo_purchasers||0,document.getElementById("totalRevenue").textContent=`R$ ${(t.total_revenue||0).toFixed(2)}`;const e=t.total_participants>0?(t.confirmed_participants/t.total_participants*100).toFixed(1):0,a=t.total_participants>0?(t.photo_purchasers/t.total_participants*100).toFixed(1):0,n=t.total_participants>0?(t.total_revenue/t.total_participants).toFixed(2):0;document.getElementById("confirmationRate").textContent=`${e}% taxa de confirmação`,document.getElementById("purchaseRate").textContent=`${a}% taxa de compra`,document.getElementById("revenuePerParticipant").textContent=`R$ ${n} por participante`,document.getElementById("participantsChange").textContent=`${t.participants_change>0?"+":""}${t.participants_change}% vs. último evento`}populateLocationFilter(){const t=[...new Set(this.participants.map(t=>t.city).filter(Boolean))].sort(),e=document.getElementById("locationFilter");t.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)})}updateAgeRangeLabels(){const t=document.getElementById("ageMin").value,e=document.getElementById("ageMax").value;document.getElementById("ageMinLabel").textContent=t,document.getElementById("ageMaxLabel").textContent=e}applyFilters(){const t=parseInt(document.getElementById("ageMin").value),e=parseInt(document.getElementById("ageMax").value),a=document.getElementById("genderFilter").value,n=document.getElementById("locationFilter").value,i=document.getElementById("registrationDateFilter").value,o=document.getElementById("participationStatusFilter").value,s=document.getElementById("photoPurchasesFilter").value;this.filteredParticipants=this.participants.filter(r=>{if(r.age<t||r.age>e)return!1;if("all"!==a&&r.gender!==a)return!1;if("all"!==n&&r.city!==n)return!1;if("all"!==i){const t=new Date(r.registration_date),e=new Date;switch(i){case"last_24h":if(e-t>864e5)return!1;break;case"last_week":if(e-t>6048e5)return!1;break;case"last_month":if(e-t>2592e6)return!1}}if("all"!==o&&r.status!==o)return!1;if("all"!==s){const t=r.total_spent||0;switch(s){case"purchased":if(0===t)return!1;break;case"not_purchased":if(t>0)return!1;break;case"high_value":if(t<=100)return!1;break;case"medium_value":if(t<50||t>100)return!1;break;case"low_value":if(t>=50)return!1}}return!0}),this.updateFilterResults(),this.updateCharts(),this.updateParticipantsTable()}updateFilterResults(){document.getElementById("filteredCount").textContent=this.filteredParticipants.length,document.getElementById("totalCount").textContent=this.participants.length}applyQuickFilter(t){switch(t){case"vip":document.getElementById("photoPurchasesFilter").value="high_value";break;case"high_engagement":break;case"potential_buyers":document.getElementById("photoPurchasesFilter").value="not_purchased",document.getElementById("participationStatusFilter").value="attended"}this.applyFilters()}resetFilters(){document.getElementById("ageMin").value=0,document.getElementById("ageMax").value=100,document.getElementById("genderFilter").value="all",document.getElementById("locationFilter").value="all",document.getElementById("registrationDateFilter").value="all",document.getElementById("participationStatusFilter").value="all",document.getElementById("photoPurchasesFilter").value="all",this.updateAgeRangeLabels(),this.applyFilters()}initializeCharts(){this.createDemographicsChart(),this.createRegistrationTimelineChart(),this.createEngagementChart(),this.createRevenueChart(),this.createConversionFunnelChart(),this.createActivityHeatmap()}createDemographicsChart(){const t=document.getElementById("demographicsChart").getContext("2d");this.charts.demographics=new Chart(t,{type:"doughnut",data:this.getDemographicsData("age"),options:{responsive:!0,plugins:{legend:{position:"bottom"}}}})}getDemographicsData(t){const e=this.filteredParticipants;switch(t){case"age":const t={"18-25":0,"26-35":0,"36-45":0,"46-55":0,"56+":0};return e.forEach(e=>{const a=e.age||0;a>=18&&a<=25?t["18-25"]++:a>=26&&a<=35?t["26-35"]++:a>=36&&a<=45?t["36-45"]++:a>=46&&a<=55?t["46-55"]++:a>=56&&t["56+"]++}),{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57"]}]};case"gender":const a={};return e.forEach(t=>{const e=t.gender||"not_informed";a[e]=(a[e]||0)+1}),{labels:Object.keys(a),datasets:[{data:Object.values(a),backgroundColor:["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4"]}]};case"location":const n={};return e.forEach(t=>{const e=t.city||"Não informado";n[e]=(n[e]||0)+1}),{labels:Object.keys(n),datasets:[{data:Object.values(n),backgroundColor:["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57","#FF9FF3"]}]}}}updateDemographicsChart(){const t=document.getElementById("demographicsType").value;this.charts.demographics.data=this.getDemographicsData(t),this.charts.demographics.update()}createRegistrationTimelineChart(){const t=document.getElementById("registrationTimelineChart").getContext("2d");this.charts.timeline=new Chart(t,{type:"line",data:this.getTimelineData("daily"),options:{responsive:!0,scales:{y:{beginAtZero:!0}}}})}getTimelineData(t){const e=this.filteredParticipants,a={};e.forEach(e=>{const n=new Date(e.registration_date);let i;switch(t){case"daily":i=n.toISOString().split("T")[0];break;case"hourly":i=`${n.toISOString().split("T")[0]} ${n.getHours()}:00`;break;case"weekly":const t=new Date(n);t.setDate(n.getDate()-n.getDay()),i=t.toISOString().split("T")[0]}a[i]=(a[i]||0)+1});const n=Object.keys(a).sort();return{labels:n,datasets:[{label:"Inscrições",data:n.map(t=>a[t]),borderColor:"#4ECDC4",backgroundColor:"rgba(78, 205, 196, 0.1)",fill:!0}]}}updateRegistrationTimelineChart(){const t=document.getElementById("timelineGranularity").value;this.charts.timeline.data=this.getTimelineData(t),this.charts.timeline.update()}createEngagementChart(){const t=document.getElementById("engagementChart").getContext("2d"),e=this.getEngagementData();this.charts.engagement=new Chart(t,{type:"radar",data:e,options:{responsive:!0,scales:{r:{beginAtZero:!0,max:100}}}})}getEngagementData(){const t=this.filteredParticipants,e=t.length,a={"Taxa de Confirmação":(t.filter(t=>"confirmed"===t.status).length/e*100).toFixed(1),"Taxa de Comparecimento":(t.filter(t=>"attended"===t.status).length/e*100).toFixed(1),"Taxa de Compra":(t.filter(t=>t.total_spent>0).length/e*100).toFixed(1),"Engajamento Social":100*Math.random(),"Satisfação":100*Math.random()};return{labels:Object.keys(a),datasets:[{label:"Engajamento (%)",data:Object.values(a),borderColor:"#FF6B6B",backgroundColor:"rgba(255, 107, 107, 0.2)",pointBackgroundColor:"#FF6B6B"}]}}createRevenueChart(){const t=document.getElementById("revenueChart").getContext("2d");this.charts.revenue=new Chart(t,{type:"bar",data:this.getRevenueData("by_participant"),options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{callback:function(t){return"R$ "+t.toFixed(2)}}}}}})}getRevenueData(t){const e=this.filteredParticipants;if("by_participant"===t){const t={"R$ 0":0,"R$ 1-50":0,"R$ 51-100":0,"R$ 101-200":0,"R$ 200+":0};return e.forEach(e=>{const a=e.total_spent||0;0===a?t["R$ 0"]++:a<=50?t["R$ 1-50"]++:a<=100?t["R$ 51-100"]++:a<=200?t["R$ 101-200"]++:t["R$ 200+"]++}),{labels:Object.keys(t),datasets:[{label:"Número de Participantes",data:Object.values(t),backgroundColor:"#45B7D1"}]}}}updateRevenueChart(){const t=document.getElementById("revenueBreakdown").value;this.charts.revenue.data=this.getRevenueData(t),this.charts.revenue.update()}createConversionFunnelChart(){const t=document.getElementById("conversionFunnelChart").getContext("2d"),e=this.getFunnelData();this.charts.funnel=new Chart(t,{type:"bar",data:e,options:{indexAxis:"y",responsive:!0,plugins:{legend:{display:!1}}}})}getFunnelData(){const t=this.filteredParticipants,e={Visitantes:3*this.participants.length,Inscritos:t.length,Confirmados:t.filter(t=>"confirmed"===t.status).length,Compareceram:t.filter(t=>"attended"===t.status).length,"Compraram Fotos":t.filter(t=>t.total_spent>0).length};return{labels:Object.keys(e),datasets:[{data:Object.values(e),backgroundColor:["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57"]}]}}createActivityHeatmap(){const t=document.getElementById("activityHeatmap"),e=this.getHeatmapData();t.innerHTML=this.generateHeatmapHTML(e)}getHeatmapData(){const t=this.filteredParticipants,e={};for(let t=0;t<7;t++){e[t]={};for(let a=0;a<24;a++)e[t][a]=0}return t.forEach(t=>{const a=new Date(t.registration_date),n=a.getDay(),i=a.getHours();e[n][i]++}),e}generateHeatmapHTML(t){const e=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],a=Math.max(...Object.values(t).map(t=>Math.max(...Object.values(t))));let n='<div class="heatmap-grid">';n+='<div class="heatmap-header">',n+='<div class="heatmap-cell"></div>';for(let t=0;t<24;t++)n+=`<div class="heatmap-cell hour-label">${t}</div>`;n+="</div>";for(let i=0;i<7;i++){n+='<div class="heatmap-row">',n+=`<div class="heatmap-cell day-label">${e[i]}</div>`;for(let o=0;o<24;o++){const s=t[i][o];n+=`<div class="heatmap-cell heatmap-data" \n                            style="background-color: ${`rgba(69, 183, 209, ${a>0?s/a:0})`}" \n                            title="${e[i]} ${o}:00 - ${s} inscrições">\n                            ${s>0?s:""}\n                         </div>`}n+="</div>"}return n+="</div>",n}updateCharts(){this.charts.demographics&&this.updateDemographicsChart(),this.charts.timeline&&this.updateRegistrationTimelineChart(),this.charts.engagement&&(this.charts.engagement.data=this.getEngagementData(),this.charts.engagement.update()),this.charts.revenue&&this.updateRevenueChart(),this.charts.funnel&&(this.charts.funnel.data=this.getFunnelData(),this.charts.funnel.update()),this.createActivityHeatmap()}updateParticipantsTable(){const t=document.getElementById("participantsTableBody"),e=document.getElementById("tablePageSize").value;let a=[...this.filteredParticipants];const n=document.getElementById("participantSearch").value.toLowerCase();n&&(a=a.filter(t=>t.name.toLowerCase().includes(n)||t.email.toLowerCase().includes(n)||t.city.toLowerCase().includes(n))),"all"!==e&&(a=a.slice(0,parseInt(e))),t.innerHTML=a.map(t=>`\n            <tr>\n                <td><input type="checkbox" class="participant-checkbox" value="${t.id}"></td>\n                <td>${t.name}</td>\n                <td>${t.email}</td>\n                <td>${t.age||"-"}</td>\n                <td>${t.city||"-"}</td>\n                <td>${this.formatDate(t.registration_date)}</td>\n                <td><span class="badge bg-${this.getStatusColor(t.status)}">${t.status}</span></td>\n                <td>${t.photos_purchased||0}</td>\n                <td>R$ ${(t.total_spent||0).toFixed(2)}</td>\n                <td>\n                    <button class="btn btn-sm btn-outline-primary" onclick="viewParticipantDetails('${t.id}')">\n                        <i class="bi bi-eye"></i>\n                    </button>\n                    <button class="btn btn-sm btn-outline-success" onclick="contactParticipant('${t.id}')">\n                        <i class="bi bi-chat"></i>\n                    </button>\n                </td>\n            </tr>\n        `).join("")}getStatusColor(t){return{registered:"primary",confirmed:"success",attended:"info",no_show:"warning",cancelled:"danger"}[t]||"secondary"}filterParticipantsTable(){this.updateParticipantsTable()}sortParticipantsTable(t){console.log("Sorting by:",t)}toggleSelectAll(t){document.querySelectorAll(".participant-checkbox").forEach(e=>{e.checked=t})}generateInsights(){const t=this.analyzeData();document.getElementById("insightsGrid").innerHTML=t.map(t=>`\n            <div class="insight-card ${t.type}">\n                <div class="insight-icon">\n                    <i class="bi ${t.icon}"></i>\n                </div>\n                <div class="insight-content">\n                    <h6>${t.title}</h6>\n                    <p>${t.description}</p>\n                    ${t.action?`<button class="btn btn-sm btn-outline-primary">${t.action}</button>`:""}\n                </div>\n            </div>\n        `).join("")}analyzeData(){const t=this.filteredParticipants,e=[],a={};t.forEach(t=>{const e=new Date(t.registration_date).getHours();a[e]=(a[e]||0)+1});const n=Object.keys(a).reduce((t,e)=>a[t]>a[e]?t:e);e.push({type:"info",icon:"bi-clock",title:"Horário de Pico",description:`A maioria das inscrições acontece às ${n}:00. Considere agendar campanhas para este horário.`,action:"Agendar Campanha"});const i=t.filter(t=>t.total_spent>100).length;i>0&&e.push({type:"success",icon:"bi-star",title:"Clientes Premium",description:`${i} participantes gastaram mais de R$ 100. Crie ofertas especiais para este grupo.`,action:"Criar Segmento VIP"});const o=t.filter(t=>t.total_spent>0).length/t.length*100;return o<20&&e.push({type:"warning",icon:"bi-exclamation-triangle",title:"Taxa de Conversão Baixa",description:`Apenas ${o.toFixed(1)}% dos participantes compraram fotos. Considere estratégias de engajamento.`,action:"Ver Sugestões"}),e}async exportToPDF(){if(!window.jsPDF)return void alert("Biblioteca PDF não carregada. Tente novamente em alguns segundos.");const{jsPDF:t}=window.jsPDF,e=new t;e.setFontSize(20),e.text("Relatório de Analytics do Evento",20,30),e.setFontSize(12),e.text(`Evento: ${document.getElementById("eventName").textContent}`,20,50),e.text(`Data do Relatório: ${(new Date).toLocaleDateString("pt-BR")}`,20,60),e.text("Métricas Principais:",20,80),e.text(`Total de Participantes: ${document.getElementById("totalParticipants").textContent}`,30,90),e.text(`Confirmados: ${document.getElementById("confirmedParticipants").textContent}`,30,100),e.text(`Compraram Fotos: ${document.getElementById("photoPurchasers").textContent}`,30,110),e.text(`Receita Total: ${document.getElementById("totalRevenue").textContent}`,30,120);let a=140;e.text("Lista de Participantes:",20,a),a+=10,this.filteredParticipants.slice(0,20).forEach((t,n)=>{a>250&&(e.addPage(),a=30),e.text(`${n+1}. ${t.name} - ${t.email} - R$ ${(t.total_spent||0).toFixed(2)}`,30,a),a+=10}),e.save(`relatorio-evento-${this.currentEvent}.pdf`)}async exportToExcel(){if(!window.XLSX)return void alert("Biblioteca Excel não carregada. Tente novamente em alguns segundos.");const t=XLSX.utils.book_new(),e=this.filteredParticipants.map(t=>({Nome:t.name,Email:t.email,Idade:t.age||"","Gênero":t.gender||"",Cidade:t.city||"","Data de Inscrição":this.formatDate(t.registration_date),Status:t.status,"Fotos Compradas":t.photos_purchased||0,"Valor Gasto":t.total_spent||0})),a=XLSX.utils.json_to_sheet(e);XLSX.utils.book_append_sheet(t,a,"Participantes");const n=[["Métrica","Valor"],["Total de Participantes",document.getElementById("totalParticipants").textContent],["Confirmados",document.getElementById("confirmedParticipants").textContent],["Compraram Fotos",document.getElementById("photoPurchasers").textContent],["Receita Total",document.getElementById("totalRevenue").textContent]],i=XLSX.utils.aoa_to_sheet(n);XLSX.utils.book_append_sheet(t,i,"Resumo"),XLSX.writeFile(t,`dados-evento-${this.currentEvent}.xlsx`)}exportParticipantsList(){const t=this.getSelectedParticipants();t.length>0||this.filteredParticipants;this.exportToExcel()}exportCustomReport(){new bootstrap.Modal(document.getElementById("exportModal")).show()}executeCustomExport(){const t=document.querySelector('input[name="exportFormat"]:checked').value,e={basicInfo:document.getElementById("exportBasicInfo").checked,demographics:document.getElementById("exportDemographics").checked,purchases:document.getElementById("exportPurchases").checked,engagement:document.getElementById("exportEngagement").checked,charts:document.getElementById("exportCharts").checked};switch(t){case"pdf":this.exportCustomPDF(e);break;case"excel":this.exportCustomExcel(e);break;case"csv":this.exportCustomCSV(e)}bootstrap.Modal.getInstance(document.getElementById("exportModal")).hide()}exportCustomPDF(t){this.exportToPDF()}exportCustomExcel(t){this.exportToExcel()}exportCustomCSV(t){const e=this.filteredParticipants.map(t=>[t.name,t.email,t.age||"",t.gender||"",t.city||"",this.formatDate(t.registration_date),t.status,t.photos_purchased||0,t.total_spent||0]);e.unshift(["Nome","Email","Idade","Gênero","Cidade","Data de Inscrição","Status","Fotos Compradas","Valor Gasto"]);const a=e.map(t=>t.join(",")).join("\n"),n=new Blob([a],{type:"text/csv"}),i=window.URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`participantes-evento-${this.currentEvent}.csv`,o.click(),window.URL.revokeObjectURL(i)}getSelectedParticipants(){const t=Array.from(document.querySelectorAll(".participant-checkbox:checked")).map(t=>t.value);return this.filteredParticipants.filter(e=>t.includes(e.id))}refreshDashboard(){this.loadEventData()}formatDate(t){return new Date(t).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}getAuthToken(){return localStorage.getItem("fotos63_auth_token")||""}}function refreshDashboard(){eventAnalytics.refreshDashboard()}function exportToPDF(){eventAnalytics.exportToPDF()}function exportToExcel(){eventAnalytics.exportToExcel()}function exportParticipantsList(){eventAnalytics.exportParticipantsList()}function exportCustomReport(){eventAnalytics.exportCustomReport()}function executeCustomExport(){eventAnalytics.executeCustomExport()}function applyQuickFilter(t){eventAnalytics.applyQuickFilter(t)}function resetFilters(){eventAnalytics.resetFilters()}function viewParticipantDetails(t){alert(`Ver detalhes do participante ${t} - Em desenvolvimento`)}function contactParticipant(t){alert(`Contatar participante ${t} - Em desenvolvimento`)}const eventAnalytics=new EventAnalyticsDashboard;"undefined"!=typeof module&&module.exports&&(module.exports=EventAnalyticsDashboard);