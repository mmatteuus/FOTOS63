class EmailMarketingSystem{constructor(){this.campaigns=[],this.templates=[],this.subscribers=[],this.segments=[],this.automations=[],this.analytics={},this.initializeSystem()}initializeSystem(){this.loadCampaigns(),this.loadTemplates(),this.loadSubscribers(),this.loadSegments(),this.setupEmailProviders()}setupEmailProviders(){this.emailProviders={sendgrid:{name:"SendGrid",apiKey:process.env.SENDGRID_API_KEY,endpoint:"https://api.sendgrid.com/v3/mail/send"},mailgun:{name:"Mailgun",apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},ses:{name:"Amazon SES",accessKey:process.env.AWS_ACCESS_KEY,secretKey:process.env.AWS_SECRET_KEY,region:process.env.AWS_REGION}}}createEmailMarketingInterface(e){const n=document.getElementById(e);n?(n.innerHTML='\n            <div class="email-marketing">\n                <div class="email-header">\n                    <h3><i class="bi bi-envelope-heart"></i> E-mail Marketing</h3>\n                    <div class="header-actions">\n                        <button class="btn btn-outline-primary" onclick="showTemplateLibrary()">\n                            <i class="bi bi-collection"></i> Templates\n                        </button>\n                        <button class="btn btn-primary" onclick="createNewCampaign()">\n                            <i class="bi bi-plus-circle"></i> Nova Campanha\n                        </button>\n                    </div>\n                </div>\n\n                \x3c!-- Email Marketing Stats --\x3e\n                <div class="email-stats">\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-people"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="totalSubscribers">0</h4>\n                            <p>Assinantes</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-send"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="emailsSent">0</h4>\n                            <p>E-mails Enviados</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-eye"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="openRate">0%</h4>\n                            <p>Taxa de Abertura</p>\n                        </div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-icon">\n                            <i class="bi bi-cursor"></i>\n                        </div>\n                        <div class="stat-info">\n                            <h4 id="clickRate">0%</h4>\n                            <p>Taxa de Clique</p>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Campaign Tabs --\x3e\n                <div class="campaign-tabs">\n                    <button class="tab-btn active" data-tab="campaigns">Campanhas</button>\n                    <button class="tab-btn" data-tab="automations">Automações</button>\n                    <button class="tab-btn" data-tab="segments">Segmentos</button>\n                    <button class="tab-btn" data-tab="analytics">Analytics</button>\n                </div>\n\n                \x3c!-- Campaigns Tab --\x3e\n                <div class="tab-content active" id="campaigns-tab">\n                    <div class="campaign-filters">\n                        <select class="form-control" id="campaignStatusFilter">\n                            <option value="all">Todos os Status</option>\n                            <option value="draft">Rascunho</option>\n                            <option value="scheduled">Agendada</option>\n                            <option value="sending">Enviando</option>\n                            <option value="sent">Enviada</option>\n                            <option value="paused">Pausada</option>\n                        </select>\n                        <input type="text" class="form-control" id="campaignSearch" placeholder="Buscar campanhas...">\n                    </div>\n\n                    <div class="campaigns-list" id="campaignsList">\n                        \x3c!-- Campaigns will be loaded here --\x3e\n                    </div>\n                </div>\n\n                \x3c!-- Automations Tab --\x3e\n                <div class="tab-content" id="automations-tab">\n                    <div class="automations-header">\n                        <h4>Automações de E-mail</h4>\n                        <button class="btn btn-primary" onclick="createAutomation()">\n                            <i class="bi bi-gear"></i> Nova Automação\n                        </button>\n                    </div>\n\n                    <div class="automation-templates">\n                        <div class="template-grid">\n                            <div class="automation-template" onclick="createWelcomeAutomation()">\n                                <i class="bi bi-hand-thumbs-up"></i>\n                                <h5>Boas-vindas</h5>\n                                <p>Sequência de boas-vindas para novos usuários</p>\n                            </div>\n                            <div class="automation-template" onclick="createEventAutomation()">\n                                <i class="bi bi-calendar-event"></i>\n                                <h5>Eventos</h5>\n                                <p>Notificações automáticas de eventos</p>\n                            </div>\n                            <div class="automation-template" onclick="createPhotoAutomation()">\n                                <i class="bi bi-camera"></i>\n                                <h5>Fotos Disponíveis</h5>\n                                <p>Avisos quando fotos estão disponíveis</p>\n                            </div>\n                            <div class="automation-template" onclick="createRetentionAutomation()">\n                                <i class="bi bi-arrow-repeat"></i>\n                                <h5>Retenção</h5>\n                                <p>Campanhas para reativar usuários inativos</p>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class="active-automations" id="activeAutomations">\n                        \x3c!-- Active automations will be shown here --\x3e\n                    </div>\n                </div>\n\n                \x3c!-- Segments Tab --\x3e\n                <div class="tab-content" id="segments-tab">\n                    <div class="segments-header">\n                        <h4>Segmentação de Audiência</h4>\n                        <button class="btn btn-primary" onclick="createSegment()">\n                            <i class="bi bi-funnel"></i> Novo Segmento\n                        </button>\n                    </div>\n\n                    <div class="segments-list" id="segmentsList">\n                        \x3c!-- Segments will be loaded here --\x3e\n                    </div>\n                </div>\n\n                \x3c!-- Analytics Tab --\x3e\n                <div class="tab-content" id="analytics-tab">\n                    <div class="analytics-dashboard">\n                        <div class="analytics-header">\n                            <h4>Analytics de E-mail Marketing</h4>\n                            <div class="date-range-picker">\n                                <input type="date" id="analyticsStartDate" class="form-control">\n                                <input type="date" id="analyticsEndDate" class="form-control">\n                                <button class="btn btn-outline-primary" onclick="updateAnalytics()">Atualizar</button>\n                            </div>\n                        </div>\n\n                        <div class="analytics-charts">\n                            <div class="chart-container">\n                                <canvas id="emailPerformanceChart"></canvas>\n                            </div>\n                            <div class="chart-container">\n                                <canvas id="subscriberGrowthChart"></canvas>\n                            </div>\n                        </div>\n\n                        <div class="analytics-details">\n                            <div class="detail-card">\n                                <h5>Top Campanhas</h5>\n                                <div id="topCampaigns">\n                                    \x3c!-- Top campaigns will be shown here --\x3e\n                                </div>\n                            </div>\n                            <div class="detail-card">\n                                <h5>Segmentos Mais Engajados</h5>\n                                <div id="topSegments">\n                                    \x3c!-- Top segments will be shown here --\x3e\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Campaign Builder Modal --\x3e\n                <div class="modal fade" id="campaignBuilderModal" tabindex="-1">\n                    <div class="modal-dialog modal-xl">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title">Criar Campanha de E-mail</h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <div class="campaign-builder">\n                                    \x3c!-- Campaign builder steps --\x3e\n                                    <div class="builder-steps">\n                                        <div class="step active" data-step="1">\n                                            <span class="step-number">1</span>\n                                            <span class="step-title">Configuração</span>\n                                        </div>\n                                        <div class="step" data-step="2">\n                                            <span class="step-number">2</span>\n                                            <span class="step-title">Audiência</span>\n                                        </div>\n                                        <div class="step" data-step="3">\n                                            <span class="step-number">3</span>\n                                            <span class="step-title">Conteúdo</span>\n                                        </div>\n                                        <div class="step" data-step="4">\n                                            <span class="step-number">4</span>\n                                            <span class="step-title">Revisão</span>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Step 1: Configuration --\x3e\n                                    <div class="builder-step active" id="step-1">\n                                        <h5>Configuração da Campanha</h5>\n                                        <div class="row">\n                                            <div class="col-md-8">\n                                                <div class="form-group">\n                                                    <label>Nome da Campanha</label>\n                                                    <input type="text" class="form-control" id="campaignName" placeholder="Ex: Promoção de Verão 2024">\n                                                </div>\n                                            </div>\n                                            <div class="col-md-4">\n                                                <div class="form-group">\n                                                    <label>Tipo de Campanha</label>\n                                                    <select class="form-control" id="campaignType">\n                                                        <option value="promotional">Promocional</option>\n                                                        <option value="newsletter">Newsletter</option>\n                                                        <option value="event">Evento</option>\n                                                        <option value="announcement">Anúncio</option>\n                                                        <option value="educational">Educacional</option>\n                                                    </select>\n                                                </div>\n                                            </div>\n                                        </div>\n\n                                        <div class="row">\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Assunto do E-mail</label>\n                                                    <input type="text" class="form-control" id="emailSubject" placeholder="Assunto atrativo para o e-mail">\n                                                    <small class="text-muted">Dica: Use emojis e personalização para aumentar a taxa de abertura</small>\n                                                </div>\n                                            </div>\n                                            <div class="col-md-6">\n                                                <div class="form-group">\n                                                    <label>Nome do Remetente</label>\n                                                    <input type="text" class="form-control" id="senderName" value="Fotos63" placeholder="Nome que aparecerá como remetente">\n                                                </div>\n                                            </div>\n                                        </div>\n\n                                        <div class="form-group">\n                                            <label>Texto de Prévia</label>\n                                            <input type="text" class="form-control" id="previewText" placeholder="Texto que aparece na prévia do e-mail">\n                                        </div>\n\n                                        <div class="scheduling-options">\n                                            <h6>Agendamento</h6>\n                                            <div class="form-check">\n                                                <input class="form-check-input" type="radio" name="sendOption" id="sendNow" value="now" checked>\n                                                <label class="form-check-label" for="sendNow">Enviar Agora</label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input class="form-check-input" type="radio" name="sendOption" id="sendLater" value="later">\n                                                <label class="form-check-label" for="sendLater">Agendar Envio</label>\n                                            </div>\n                                            <div class="schedule-datetime" id="scheduleDateTime" style="display: none;">\n                                                <input type="datetime-local" class="form-control" id="scheduledTime">\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Step 2: Audience --\x3e\n                                    <div class="builder-step" id="step-2">\n                                        <h5>Selecionar Audiência</h5>\n                                        <div class="audience-options">\n                                            <div class="audience-option">\n                                                <div class="form-check">\n                                                    <input class="form-check-input" type="radio" name="audienceType" id="allSubscribers" value="all" checked>\n                                                    <label class="form-check-label" for="allSubscribers">\n                                                        <strong>Todos os Assinantes</strong>\n                                                        <span class="subscriber-count" id="allSubscribersCount">0 pessoas</span>\n                                                    </label>\n                                                </div>\n                                            </div>\n\n                                            <div class="audience-option">\n                                                <div class="form-check">\n                                                    <input class="form-check-input" type="radio" name="audienceType" id="segments" value="segments">\n                                                    <label class="form-check-label" for="segments">\n                                                        <strong>Segmentos Específicos</strong>\n                                                        <span>Enviar para grupos segmentados</span>\n                                                    </label>\n                                                </div>\n                                                <div class="segments-selection" id="segmentsSelection" style="display: none;">\n                                                    \x3c!-- Segments will be loaded here --\x3e\n                                                </div>\n                                            </div>\n\n                                            <div class="audience-option">\n                                                <div class="form-check">\n                                                    <input class="form-check-input" type="radio" name="audienceType" id="custom" value="custom">\n                                                    <label class="form-check-label" for="custom">\n                                                        <strong>Seleção Personalizada</strong>\n                                                        <span>Criar filtros personalizados</span>\n                                                    </label>\n                                                </div>\n                                                <div class="custom-filters" id="customFilters" style="display: none;">\n                                                    \x3c!-- Custom filters will be added here --\x3e\n                                                </div>\n                                            </div>\n                                        </div>\n\n                                        <div class="audience-preview">\n                                            <h6>Prévia da Audiência</h6>\n                                            <div class="preview-stats">\n                                                <span class="stat">Total: <strong id="audienceTotal">0</strong></span>\n                                                <span class="stat">Fotógrafos: <strong id="audiencePhotographers">0</strong></span>\n                                                <span class="stat">Clientes: <strong id="audienceClients">0</strong></span>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Step 3: Content --\x3e\n                                    <div class="builder-step" id="step-3">\n                                        <h5>Criar Conteúdo</h5>\n                                        <div class="content-options">\n                                            <div class="template-selector">\n                                                <h6>Escolher Template</h6>\n                                                <div class="template-grid" id="templateGrid">\n                                                    \x3c!-- Templates will be loaded here --\x3e\n                                                </div>\n                                            </div>\n\n                                            <div class="email-editor">\n                                                <div class="editor-toolbar">\n                                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertPersonalization()">\n                                                        <i class="bi bi-person"></i> Personalizar\n                                                    </button>\n                                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertImage()">\n                                                        <i class="bi bi-image"></i> Imagem\n                                                    </button>\n                                                    <button class="btn btn-sm btn-outline-secondary" onclick="insertButton()">\n                                                        <i class="bi bi-square"></i> Botão\n                                                    </button>\n                                                </div>\n                                                <div class="editor-content">\n                                                    <textarea id="emailContent" class="form-control" rows="15" placeholder="Conteúdo do e-mail..."></textarea>\n                                                </div>\n                                            </div>\n\n                                            <div class="email-preview">\n                                                <h6>Prévia do E-mail</h6>\n                                                <div class="preview-container" id="emailPreview">\n                                                    \x3c!-- Email preview will be shown here --\x3e\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Step 4: Review --\x3e\n                                    <div class="builder-step" id="step-4">\n                                        <h5>Revisão Final</h5>\n                                        <div class="campaign-summary">\n                                            <div class="summary-section">\n                                                <h6>Configuração</h6>\n                                                <p><strong>Nome:</strong> <span id="summaryName">-</span></p>\n                                                <p><strong>Assunto:</strong> <span id="summarySubject">-</span></p>\n                                                <p><strong>Tipo:</strong> <span id="summaryType">-</span></p>\n                                                <p><strong>Agendamento:</strong> <span id="summarySchedule">-</span></p>\n                                            </div>\n\n                                            <div class="summary-section">\n                                                <h6>Audiência</h6>\n                                                <p><strong>Total de Destinatários:</strong> <span id="summaryAudience">0</span></p>\n                                                <p><strong>Tipo de Seleção:</strong> <span id="summaryAudienceType">-</span></p>\n                                            </div>\n\n                                            <div class="summary-section">\n                                                <h6>Estimativas</h6>\n                                                <p><strong>Taxa de Abertura Esperada:</strong> <span id="expectedOpenRate">25%</span></p>\n                                                <p><strong>Taxa de Clique Esperada:</strong> <span id="expectedClickRate">3%</span></p>\n                                                <p><strong>Custo Estimado:</strong> <span id="estimatedCost">R$ 0,00</span></p>\n                                            </div>\n                                        </div>\n\n                                        <div class="test-email">\n                                            <h6>Enviar E-mail de Teste</h6>\n                                            <div class="input-group">\n                                                <input type="email" class="form-control" id="testEmail" placeholder="seu@email.com">\n                                                <button class="btn btn-outline-primary" onclick="sendTestEmail()">\n                                                    <i class="bi bi-send"></i> Enviar Teste\n                                                </button>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-secondary" id="prevStepBtn" onclick="previousStep()" style="display: none;">\n                                    <i class="bi bi-arrow-left"></i> Anterior\n                                </button>\n                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>\n                                <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextStep()">\n                                    Próximo <i class="bi bi-arrow-right"></i>\n                                </button>\n                                <button type="button" class="btn btn-success" id="launchCampaignBtn" onclick="launchCampaign()" style="display: none;">\n                                    <i class="bi bi-rocket"></i> Lançar Campanha\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',this.setupEmailMarketingEvents(),this.loadEmailMarketingData()):console.error(`Container ${e} not found`)}setupEmailMarketingEvents(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",e=>{this.switchTab(e.target.dataset.tab)})}),document.querySelectorAll('input[name="sendOption"]').forEach(e=>{e.addEventListener("change",e=>{document.getElementById("scheduleDateTime").style.display="later"===e.target.value?"block":"none"})}),document.querySelectorAll('input[name="audienceType"]').forEach(e=>{e.addEventListener("change",e=>{this.handleAudienceTypeChange(e.target.value)})}),document.getElementById("emailContent").addEventListener("input",()=>{this.updateEmailPreview()}),document.getElementById("campaignStatusFilter").addEventListener("change",()=>{this.filterCampaigns()}),document.getElementById("campaignSearch").addEventListener("input",()=>{this.filterCampaigns()})}async loadEmailMarketingData(){await Promise.all([this.loadCampaigns(),this.loadTemplates(),this.loadSubscribers(),this.loadSegments(),this.loadAnalytics()]),this.updateEmailStats(),this.loadCampaignsUI()}async loadCampaigns(){try{const e=await fetch("/api/email/campaigns",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.campaigns=await e.json())}catch(e){console.error("Error loading campaigns:",e)}}async loadTemplates(){try{const e=await fetch("/api/email/templates");e.ok&&(this.templates=await e.json())}catch(e){console.error("Error loading templates:",e)}}async loadSubscribers(){try{const e=await fetch("/api/email/subscribers",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.subscribers=await e.json())}catch(e){console.error("Error loading subscribers:",e)}}async loadSegments(){try{const e=await fetch("/api/email/segments",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.segments=await e.json())}catch(e){console.error("Error loading segments:",e)}}async loadAnalytics(){try{const e=await fetch("/api/email/analytics",{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});e.ok&&(this.analytics=await e.json())}catch(e){console.error("Error loading analytics:",e)}}updateEmailStats(){document.getElementById("totalSubscribers").textContent=this.subscribers.length,document.getElementById("emailsSent").textContent=this.analytics.total_sent||0,document.getElementById("openRate").textContent=`${(this.analytics.open_rate||0).toFixed(1)}%`,document.getElementById("clickRate").textContent=`${(this.analytics.click_rate||0).toFixed(1)}%`}switchTab(e){document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),document.getElementById(`${e}-tab`).classList.add("active"),this.loadTabContent(e)}loadTabContent(e){switch(e){case"campaigns":this.loadCampaignsUI();break;case"automations":this.loadAutomationsUI();break;case"segments":this.loadSegmentsUI();break;case"analytics":this.loadAnalyticsUI()}}loadCampaignsUI(){const e=document.getElementById("campaignsList");e&&(0!==this.campaigns.length?e.innerHTML=this.campaigns.map(e=>`\n            <div class="campaign-card" data-campaign-id="${e.id}">\n                <div class="campaign-header">\n                    <div class="campaign-info">\n                        <h5>${e.name}</h5>\n                        <p class="campaign-subject">${e.subject}</p>\n                    </div>\n                    <div class="campaign-status">\n                        <span class="badge bg-${this.getCampaignStatusColor(e.status)}">${e.status}</span>\n                    </div>\n                </div>\n\n                <div class="campaign-stats">\n                    <div class="stat">\n                        <span class="stat-value">${e.recipients||0}</span>\n                        <span class="stat-label">Destinatários</span>\n                    </div>\n                    <div class="stat">\n                        <span class="stat-value">${(e.open_rate||0).toFixed(1)}%</span>\n                        <span class="stat-label">Abertura</span>\n                    </div>\n                    <div class="stat">\n                        <span class="stat-value">${(e.click_rate||0).toFixed(1)}%</span>\n                        <span class="stat-label">Clique</span>\n                    </div>\n                    <div class="stat">\n                        <span class="stat-value">${e.conversions||0}</span>\n                        <span class="stat-label">Conversões</span>\n                    </div>\n                </div>\n\n                <div class="campaign-details">\n                    <span><i class="bi bi-calendar"></i> ${this.formatDate(e.created_at)}</span>\n                    <span><i class="bi bi-people"></i> ${this.getCampaignAudienceType(e.audience_type)}</span>\n                    <span><i class="bi bi-tag"></i> ${e.type}</span>\n                </div>\n\n                <div class="campaign-actions">\n                    <button class="btn btn-sm btn-outline-primary" onclick="viewCampaignReport('${e.id}')">\n                        <i class="bi bi-graph-up"></i> Relatório\n                    </button>\n                    <button class="btn btn-sm btn-outline-secondary" onclick="duplicateCampaign('${e.id}')">\n                        <i class="bi bi-files"></i> Duplicar\n                    </button>\n                    <button class="btn btn-sm btn-outline-success" onclick="editCampaign('${e.id}')">\n                        <i class="bi bi-pencil"></i> Editar\n                    </button>\n                </div>\n            </div>\n        `).join(""):e.innerHTML='\n                <div class="empty-state">\n                    <i class="bi bi-envelope-x"></i>\n                    <h4>Nenhuma campanha criada</h4>\n                    <p>Crie sua primeira campanha de e-mail marketing</p>\n                    <button class="btn btn-primary" onclick="createNewCampaign()">\n                        <i class="bi bi-plus-circle"></i> Criar Primeira Campanha\n                    </button>\n                </div>\n            ')}getCampaignStatusColor(e){return{draft:"secondary",scheduled:"warning",sending:"info",sent:"success",paused:"danger"}[e]||"secondary"}getCampaignAudienceType(e){return{all:"Todos",segments:"Segmentos",custom:"Personalizado"}[e]||e}createNewCampaign(){new bootstrap.Modal(document.getElementById("campaignBuilderModal")).show(),this.currentStep=1,this.resetCampaignBuilder(),this.loadTemplatesForBuilder(),this.loadSegmentsForBuilder()}resetCampaignBuilder(){document.getElementById("campaignName").value="",document.getElementById("emailSubject").value="",document.getElementById("previewText").value="",document.getElementById("emailContent").value="",document.querySelectorAll(".builder-step").forEach(e=>{e.classList.remove("active")}),document.getElementById("step-1").classList.add("active"),document.querySelectorAll(".step").forEach(e=>{e.classList.remove("active")}),document.querySelector('[data-step="1"]').classList.add("active"),document.getElementById("prevStepBtn").style.display="none",document.getElementById("nextStepBtn").style.display="inline-block",document.getElementById("launchCampaignBtn").style.display="none"}nextStep(){this.validateCurrentStep()&&(this.currentStep++,this.showStep(this.currentStep))}previousStep(){this.currentStep--,this.showStep(this.currentStep)}showStep(e){document.querySelectorAll(".step").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-step="${e}"]`).classList.add("active"),document.querySelectorAll(".builder-step").forEach(e=>{e.classList.remove("active")}),document.getElementById(`step-${e}`).classList.add("active"),document.getElementById("prevStepBtn").style.display=e>1?"inline-block":"none",document.getElementById("nextStepBtn").style.display=e<4?"inline-block":"none",document.getElementById("launchCampaignBtn").style.display=4===e?"inline-block":"none",this.loadStepContent(e)}loadStepContent(e){switch(e){case 2:this.updateAudiencePreview();break;case 3:this.updateEmailPreview();break;case 4:this.updateCampaignSummary()}}validateCurrentStep(){switch(this.currentStep){case 1:return this.validateStep1();case 2:return this.validateStep2();case 3:return this.validateStep3();default:return!0}}validateStep1(){const e=document.getElementById("campaignName").value,n=document.getElementById("emailSubject").value;return e.trim()?!!n.trim()||(alert("Por favor, digite o assunto do e-mail"),!1):(alert("Por favor, digite o nome da campanha"),!1)}validateStep2(){if("segments"===document.querySelector('input[name="audienceType"]:checked').value){if(0===document.querySelectorAll('input[name="selectedSegments"]:checked').length)return alert("Por favor, selecione pelo menos um segmento"),!1}return!0}validateStep3(){return!!document.getElementById("emailContent").value.trim()||(alert("Por favor, adicione conteúdo ao e-mail"),!1)}handleAudienceTypeChange(e){document.getElementById("segmentsSelection").style.display="none",document.getElementById("customFilters").style.display="none","segments"===e?document.getElementById("segmentsSelection").style.display="block":"custom"===e&&(document.getElementById("customFilters").style.display="block"),this.updateAudiencePreview()}updateAudiencePreview(){const e=document.querySelector('input[name="audienceType"]:checked')?.value;let n=0,t=0,a=0;switch(e){case"all":n=this.subscribers.length,t=this.subscribers.filter(e=>"photographer"===e.type).length,a=this.subscribers.filter(e=>"client"===e.type).length;break;case"segments":document.querySelectorAll('input[name="selectedSegments"]:checked').forEach(e=>{const s=this.segments.find(n=>n.id===e.value);s&&(n+=s.subscriber_count,t+=s.photographer_count||0,a+=s.client_count||0)})}document.getElementById("audienceTotal").textContent=n,document.getElementById("audiencePhotographers").textContent=t,document.getElementById("audienceClients").textContent=a}updateEmailPreview(){const e=document.getElementById("emailContent").value,n=document.getElementById("emailSubject").value,t=`\n            <div class="email-preview-container">\n                <div class="email-header">\n                    <strong>De:</strong> ${document.getElementById("senderName").value||"Fotos63"}<br>\n                    <strong>Assunto:</strong> ${n||"Sem assunto"}\n                </div>\n                <div class="email-body">\n                    ${this.processEmailContent(e)}\n                </div>\n            </div>\n        `;document.getElementById("emailPreview").innerHTML=t}processEmailContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>").replace(/{{name}}/g,'<span class="personalization">Nome do Cliente</span>').replace(/{{email}}/g,'<span class="personalization">email@cliente.com</span>')}updateCampaignSummary(){document.getElementById("summaryName").textContent=document.getElementById("campaignName").value,document.getElementById("summarySubject").textContent=document.getElementById("emailSubject").value,document.getElementById("summaryType").textContent=document.getElementById("campaignType").value;const e="now"===document.querySelector('input[name="sendOption"]:checked').value?"Enviar Agora":`Agendado para ${document.getElementById("scheduledTime").value}`;document.getElementById("summarySchedule").textContent=e;const n=document.getElementById("audienceTotal").textContent;document.getElementById("summaryAudience").textContent=n;const t=document.querySelector('input[name="audienceType"]:checked').value;document.getElementById("summaryAudienceType").textContent=this.getCampaignAudienceType(t);const a=.01*parseInt(n);document.getElementById("estimatedCost").textContent=`R$ ${a.toFixed(2)}`}loadTemplatesForBuilder(){const e=document.getElementById("templateGrid");e&&(e.innerHTML=this.templates.map(e=>`\n            <div class="template-card" onclick="selectTemplate('${e.id}')">\n                <div class="template-preview">\n                    <img src="${e.thumbnail}" alt="${e.name}">\n                </div>\n                <div class="template-info">\n                    <h6>${e.name}</h6>\n                    <p>${e.description}</p>\n                </div>\n            </div>\n        `).join(""))}loadSegmentsForBuilder(){const e=document.getElementById("segmentsSelection");e&&(e.innerHTML=this.segments.map(e=>`\n            <div class="form-check">\n                <input class="form-check-input" type="checkbox" name="selectedSegments" value="${e.id}" id="segment-${e.id}">\n                <label class="form-check-label" for="segment-${e.id}">\n                    <strong>${e.name}</strong>\n                    <span class="segment-count">${e.subscriber_count} pessoas</span>\n                    <small class="segment-description">${e.description}</small>\n                </label>\n            </div>\n        `).join(""),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{this.updateAudiencePreview()})}))}async launchCampaign(){try{const e=this.collectCampaignData(),n=await fetch("/api/email/campaigns",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify(e)});if(!n.ok)throw new Error("Erro ao criar campanha");const t=await n.json();this.campaigns.unshift(t),this.loadCampaignsUI(),this.updateEmailStats();bootstrap.Modal.getInstance(document.getElementById("campaignBuilderModal")).hide(),alert("Campanha criada e enviada com sucesso!")}catch(e){console.error("Error launching campaign:",e),alert("Erro ao lançar campanha: "+e.message)}}collectCampaignData(){const e=document.querySelector('input[name="audienceType"]:checked').value;let n=[];return"segments"===e&&(n=Array.from(document.querySelectorAll('input[name="selectedSegments"]:checked')).map(e=>e.value)),{name:document.getElementById("campaignName").value,type:document.getElementById("campaignType").value,subject:document.getElementById("emailSubject").value,preview_text:document.getElementById("previewText").value,sender_name:document.getElementById("senderName").value,content:document.getElementById("emailContent").value,audience_type:e,selected_segments:n,send_option:document.querySelector('input[name="sendOption"]:checked').value,scheduled_time:document.getElementById("scheduledTime").value,status:"now"===document.querySelector('input[name="sendOption"]:checked').value?"sending":"scheduled"}}async sendTestEmail(){const e=document.getElementById("testEmail").value;if(e)try{const n=this.collectCampaignData();if(!(await fetch("/api/email/test",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify({...n,test_email:e})})).ok)throw new Error("Erro ao enviar e-mail de teste");alert("E-mail de teste enviado com sucesso!")}catch(e){console.error("Error sending test email:",e),alert("Erro ao enviar e-mail de teste: "+e.message)}else alert("Por favor, digite um e-mail para teste")}formatDate(e){return new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}getAuthToken(){return localStorage.getItem("fotos63_auth_token")||""}}function createNewCampaign(){emailMarketing.createNewCampaign()}function nextStep(){emailMarketing.nextStep()}function previousStep(){emailMarketing.previousStep()}function launchCampaign(){emailMarketing.launchCampaign()}function sendTestEmail(){emailMarketing.sendTestEmail()}function selectTemplate(e){console.log("Template selected:",e)}function insertPersonalization(){const e=document.getElementById("emailContent"),n=e.selectionStart,t=e.value.substring(0,n),a=e.value.substring(n);e.value=t+"{{name}}"+a,emailMarketing.updateEmailPreview()}function insertImage(){alert("Funcionalidade de inserir imagem em desenvolvimento")}function insertButton(){const e=document.getElementById("emailContent"),n=e.selectionStart,t=e.value.substring(0,n),a=e.value.substring(n);e.value=t+"\n[BOTÃO: Clique Aqui](https://fotos63.com)\n"+a,emailMarketing.updateEmailPreview()}const emailMarketing=new EmailMarketingSystem;"undefined"!=typeof module&&module.exports&&(module.exports=EmailMarketingSystem);